# About

This is a terraform module that provisions a postgres server.

Given a certificate authority, it will generate its server-side certificate and key to server traffic over tls.

Given that it is the common denominator for all the clients we are using, only password authentication is supported for now.

The module will take a password as an argument for its superuser account and will generate its own if none is passed.

Postgres will run on a background container set to always restart.

It is assumed that the postgres image used has the following characteristics (which the official postgres images will have):

- The container command is passed as parameters to the **postgres** entrypoint
- The **PGDATA** environment variable indicates where postgres should store its database files
- The **POSTGRES_USER** environment variable indicates the user that will be used to access the database
- The **POSTGRES_PASSWORD** environment variable indicates the password that will be used for authentication when accessing the database
- The **POSTGRES_DB** environment variable indicates the name of the database that will be accessed
- The image has a user named "postgres" and the database will run as that user

# Limitation

Currently, only a standalone server setup is supported without ha, so very frequent backups are advised.

# Libvirt Networking Support

This module supports both libvirt networks and direct macvtap connection (bridge mode).

# Usage

## Variables

This module takes the following variables as input:

- **name**: Name to give to the vm. Will be the hostname as well.
- **vcpus**: Number of vcpus to assign to the vm. Defaults to 2.
- **memory**: Amount of memory in MiB to assign to the vm. Defaults to 8192.
- **volume_id**: Id of the image volume to attach to the vm. A recent version of ubuntu is recommended as this is what this module has been validated against.
- **network_id**: Id (ie, uuid) of the libvirt network to connect the vm to if you wish to connect the vm to a libvirt network.
- **macvtap_interface**: Host network interface that you plan to connect your vm to via a lower macvtap interface. Note that either this or network_id should be set, but not both.
- **macvtap_vm_interface_name_match**: Expected pattern of the network interface name in the vm. Defaults to "en*". Used with macvtap only.
- **macvtap_subnet_prefix_length**: Length of the subnet prefix (ie, the yy in xxx.xxx.xxx.xxx/yy) in the host network. Used with macvtap only.
- **macvtap_gateway_ip**: Ip of the host network's gateway. Used with macvtap only.
- **macvtap_dns_servers**: Ip of dns servers that the vm should explicitly use, useful mostly during the initial cloud-init bootstraping to resolve domain of installables. Used for macvtap only.
- **ip**: Ip of the vm on whichever network it is connected. Note that this isn't an optional parameter. Dhcp cannot be used.
- **mac**: Mac address of the vm. If none is passed, a random one will be generated.
- **cloud_init_volume_pool**: Name of the volume pool that will contain the cloud-init volume of the vm.
- **cloud_init_volume_name**: Name of the cloud-init volume that will be generated by the module for your vm. If left empty, it will default to **<name>-cloud-init.iso**.
- **ssh_admin_user**: Username of the default sudo user in the image. Defaults to **ubuntu**.
- **admin_user_password**: Optional password for the default sudo user of the image. Note that this will not enable ssh password connections, but it will allow you to log into the vm from the host using the **virsh console** command.
- **ssh_admin_public_key**: Public part of the ssh key the admin will be able to login as
- **postgres_image**: Docker image to use to run postgres. This module has been validated with postgres version 12 so far.
- **postgres_params**: Additional command line parameters to pass to postgres when launching it. Note that the **ssl**, **ssl_cert_file** and **ssl_key_file** parameters are already managed by the module and should not be passed.
- **postgres_user**: User that will be used to access the admin database
- **postgres_database**: Name of the admin database
- **postgres_password**: Password that will be used to access the admin database. If omitted, a random password is generated
- **organization**: Organization that will be used in the postgres server's certificate
- **certificate_validity_period**: Validity period of the server's certificate in hours. Defaults to 100 years.
- **certificate_early_renewal**: How long before the end of the validity period the certificate should be renewed in hours. Defaults to 1 year.
- **ca**: Certificate authority that will be used to sign the server's certificate. It is expected to contain the following keys: key, key_algorithm, certificate
- **key_length**: The key length of the certificate's private key in bits. Defaults to 4096
- **domains**: Domains that will be included in the server's certificate
- **chrony**: Optional chrony configuration for when you need a more fine-grained ntp setup on your vm. It is an object with the following fields:
  - **enabled**: If set the false (the default), chrony will not be installed and the vm ntp settings will be left to default.
  - **servers**: List of ntp servers to sync from with each entry containing two properties, **url** and **options** (see: https://chrony.tuxfamily.org/doc/4.2/chrony.conf.html#server)
  - **pools**: A list of ntp server pools to sync from with each entry containing two properties, **url** and **options** (see: https://chrony.tuxfamily.org/doc/4.2/chrony.conf.html#pool)
  - **makestep**: An object containing remedial instructions if the clock of the vm is significantly out of sync at startup. It is an object containing two properties, **threshold** and **limit** (see: https://chrony.tuxfamily.org/doc/4.2/chrony.conf.html#makestep)

## Output

The module outputs the following variables as output:

- **db_password**: Database password used to authenticate 
against the admin database. Will be an empty string if a non-empty password was passed to the module in the inputs.

## Example

Below is an orchestration I ran locally to troubleshoot the module.

```
resource "netaddr_address_ipv4" "postgres" {
    range_id = data.netaddr_range_ipv4.vlan.id
    name     = "test-postgres"
}

resource "netaddr_address_mac" "postgres" {
    range_id = data.netaddr_range_mac.vlan.id
    name     = "test-postgres"
}

module "postgres_domain" {
  source = "git::https://github.com/Ferlab-Ste-Justine/etcd-zonefile.git"
  domain = "postgres.local"
  key_prefix = "/coredns/"
  dns_server_name = "ns.local."
  a_records = [
    {
      prefix = ""
      ip = netaddr_address_ipv4.postgres.address
    }
  ]
}

resource "libvirt_volume" "postgres" {
  name             = "test-postgres"
  pool             = "test"
  // 50 GiB
  size             = 50 * 1024 * 1024 * 1024
  base_volume_pool = "test"
  base_volume_name = "ubuntu"
  format           = "qcow2"

  lifecycle {
    prevent_destroy = true
  }
}

module "qa_postgres" {
  source = "git::https://github.com/Ferlab-Ste-Justine/kvm-postgres-server.git"
  name = "test-postgres"
  vcpus = 2
  memory = 8192
  volume_id = libvirt_volume.postgres.id
  macvtap_interface = local.networks.vlan.interface
  macvtap_subnet_prefix_length = local.networks.vlan.prefix
  macvtap_gateway_ip = local.networks.vlan.gateway
  macvtap_dns_servers = local.networks.vlan.dns
  ip = netaddr_address_ipv4.postgres.address
  mac = netaddr_address_mac.postgres.address
  cloud_init_volume_pool = "test"
  ssh_admin_public_key = local.server_ssh_public_key
  admin_user_password = local.console_password
  postgres_image = "postgres:12.9"
  postgres_params = "-c 'shared_buffers=2GB' -c 'max_wal_size=2GB' -c 'checkpoint_timeout=30min' -c 'checkpoint_warning=10min' -c 'checkpoint_completion_target=0.9' -c 'work_mem=4MB' -c 'maintenance_work_mem=64MB'"
  postgres_user = "postgres"
  postgres_database = "postgres"
  postgres_password = local.postgres_password
  ca = local.postgres_ca
  domains = [
    "postgres.local",
    "postgres-server"
  ]
}
```

## Gotchas

### Macvtap and Host Traffic

Because of the way macvtap is setup in bridge mode, traffic from the host to the guest vm is not possible. However, traffic from other guest vms on the host or from other physical hosts on the network will work fine.

### Volume Pools, Ubuntu and Apparmor

At the time of this writing, libvirt will not set the apparmor permission of volume pools properly on recent versions of ubuntu. This will result in volumes that cannot be attached to your vms (you will get a permission error).

You need to setup the permissions in apparmor yourself for it to work.

See the following links for the bug and workaround:

- https://bugs.launchpad.net/ubuntu/+source/libvirt/+bug/1677398
- https://bugs.launchpad.net/ubuntu/+source/libvirt/+bug/1677398/comments/43

### Requisite Outgoing Traffic

Note that because cloud-init installs external dependencies, you will need working dns that can resolve names on the internet and outside connectivity for the vm.